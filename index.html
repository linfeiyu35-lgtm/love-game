<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æˆ³æˆ³æ¶ˆæ°”æ€ª Â· åŠ å¼ºç‰ˆ</title>
  <style>
    :root{
      --bg1:#fff1f6; --bg2:#eef4ff; --card:#ffffffcc;
      --text:#111; --muted:#666; --accent:#ff4d8d; --accent2:#6c7cff;
      --shadow:0 12px 30px rgba(0,0,0,.10); --r:18px;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select:none;}
    html,body{height:100%; margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"PingFang SC","Microsoft YaHei",Arial;}
    body{
      background:
        radial-gradient(1200px 700px at 20% 10%, var(--bg1), transparent 60%),
        radial-gradient(1200px 700px at 80% 0%, var(--bg2), transparent 60%),
        linear-gradient(180deg,#fff,#f7fbff);
      overflow:hidden; color:var(--text);
    }
    .wrap{height:100%; display:flex; flex-direction:column; gap:10px; padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom); max-width:560px; margin:0 auto;}
    header{
      padding:12px 14px; border-radius:var(--r);
      background:var(--card); box-shadow:var(--shadow); backdrop-filter:blur(10px);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .title{display:flex; flex-direction:column; gap:2px;}
    .title h1{margin:0; font-size:15px; font-weight:900;}
    .title p{margin:0; font-size:12px; color:var(--muted);}
    .hud{display:flex; gap:8px; align-items:center; font-variant-numeric:tabular-nums;}
    .pill{
      background:#fff; border-radius:999px; padding:8px 10px; font-size:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.08); display:flex; align-items:center; gap:6px; white-space:nowrap;
    }
    .pill b{font-size:13px;}
    .btn{
      border:none; border-radius:12px; padding:10px 12px; font-weight:900; color:#fff; cursor:pointer;
      background:linear-gradient(135deg,var(--accent),#ff7ab3);
      box-shadow:0 12px 24px rgba(255,77,141,.25);
    }
    .btn.secondary{
      background:linear-gradient(135deg,var(--accent2),#9aa5ff);
      box-shadow:0 12px 24px rgba(108,124,255,.22);
    }

    main{flex:1; position:relative; border-radius:var(--r); background:#ffffffaa; box-shadow:var(--shadow); overflow:hidden;}
    canvas{width:100%; height:100%; display:block;}

    .topbar{
      position:absolute; left:12px; right:12px; top:12px; z-index:5;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      pointer-events:none;
    }
    .meter{
      flex:1; padding:10px 12px; border-radius:14px; background:#fff; box-shadow:0 10px 24px rgba(0,0,0,.08);
      pointer-events:none;
    }
    .meter .row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .meter .small{font-size:12px; color:var(--muted);}
    .bar{
      margin-top:8px; height:10px; border-radius:999px; background:rgba(0,0,0,.06); overflow:hidden;
    }
    .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#ff4d8d,#ffa34d,#6c7cff); border-radius:999px;}
    .icons{
      display:flex; gap:8px; align-items:center; pointer-events:none;
    }
    .icon{
      min-width:44px; padding:10px 10px; border-radius:14px; background:#fff; box-shadow:0 10px 24px rgba(0,0,0,.08);
      font-size:12px; display:flex; flex-direction:column; align-items:center; gap:2px;
    }
    .icon b{font-size:12px;}
    .hint{
      position:absolute; inset:0; z-index:10;
      display:flex; align-items:center; justify-content:center; padding:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.92));
      backdrop-filter:blur(10px);
    }
    .card{
      width:100%; max-width:520px; background:#fff; border-radius:22px; box-shadow:var(--shadow); padding:16px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background:#fff3f8; color:#b10044; font-weight:800; font-size:12px;
      border:1px solid rgba(255,77,141,.25);
      margin-bottom:10px;
    }
    .card h2{margin:0 0 6px; font-size:18px;}
    .card p{margin:8px 0; font-size:13px; color:#333; line-height:1.7; white-space:pre-line;}
    .rowBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .rowBtns .btn{flex:1; min-width:130px;}
    .toast{
      position:absolute; left:50%; bottom:16px; transform:translateX(-50%);
      background:#111; color:#fff; padding:10px 12px; border-radius:999px;
      font-size:12px; opacity:0; transition:.25s ease; z-index:20; pointer-events:none;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}
    .footerNote{font-size:11px; color:var(--muted); text-align:center; padding-bottom:2px;}

    .tapTip{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      padding:10px 12px; border-radius:999px;
      background:rgba(255,255,255,.9); box-shadow:0 10px 24px rgba(0,0,0,.08);
      font-size:12px; color:#444; z-index:2;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1 id="gameTitle">æˆ³æˆ³æ¶ˆæ°”æ€ª Â· åŠ å¼ºç‰ˆ</h1>
      <p id="subtitle">è¿å‡»ã€é“å…·ã€é›·äº‘é™·é˜±ï¼šå“„äººä¹Ÿè¦æœ‰æŠ€æœ¯å«é‡</p>
    </div>
    <div class="hud">
      <div class="pill">â³ <b id="time">35.0</b>s</div>
      <div class="pill">ğŸ’— <b id="score">0</b></div>
      <div class="pill">ğŸ”¥ <b id="mult">x1</b></div>
      <button class="btn secondary" id="pauseBtn">æš‚åœ</button>
    </div>
  </header>

  <main id="stage">
    <div class="topbar">
      <div class="meter">
        <div class="row">
          <div class="small">è¿å‡»èƒ½é‡ï¼ˆè¶Šé«˜å€æ•°è¶Šå¤§ï¼‰</div>
          <div class="small">ç›®æ ‡ï¼š<b id="targetText">120</b>ğŸ’—</div>
        </div>
        <div class="bar"><i id="comboBar"></i></div>
      </div>
      <div class="icons">
        <div class="icon"><div>â­</div><b id="pStar">0</b></div>
        <div class="icon"><div>â„ï¸</div><b id="pIce">0</b></div>
        <div class="icon"><div>ğŸ’£</div><b id="pBomb">0</b></div>
      </div>
    </div>

    <div class="tapTip" id="tapTip">ç‚¹ğŸ˜¤å¾—åˆ†ï¼Œç‚¹âš¡æ‰£åˆ†ï¼é“å…·ä¼šéšæœºæ‰è½ï½</div>
    <canvas id="c"></canvas>

    <div class="hint" id="overlay">
      <div class="card">
        <div class="badge" id="badge">ğŸ é€šå…³æƒŠå–œ</div>
        <h2 id="overlayTitle">å‡†å¤‡å¼€å§‹å“„å“„æ¨¡å¼</h2>
        <p id="overlayText"></p>
        <div class="rowBtns">
          <button class="btn" id="startBtn">å¼€å§‹</button>
          <button class="btn secondary" id="copyBtn">å¤åˆ¶å“„å“„è¯</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">å·²å¤åˆ¶ âœ…</div>
  </main>

  <div class="footerNote">å°æŠ€å·§ï¼šä¿æŒè¿å‡»èƒ½é‡ > 70%ï¼Œå°±èƒ½ x3 é£™åˆ†ã€‚</div>
</div>

<script>
/** ===== è‡ªå®šä¹‰åŒºï¼šæ”¹åå­—/æ–‡æ¡ˆ ===== */
const gfName = "å®å®";          // æ”¹æˆå¥¹çš„æ˜µç§°
const myName = "æˆ‘";            // æ”¹æˆä½ çš„ç§°å‘¼/åå­—
const sorryReason = "åˆšåˆšè®©ä½ ä¸å¼€å¿ƒäº†"; // å¯ç•™ç©º
const gameSeconds = 35;
const targetScore = 120;

/** ===== å·¥å…· & DOM ===== */
const stage = document.getElementById("stage");
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d", { alpha:true });

const timeEl = document.getElementById("time");
const scoreEl = document.getElementById("score");
const multEl = document.getElementById("mult");
const pauseBtn = document.getElementById("pauseBtn");

const overlay = document.getElementById("overlay");
const overlayTitle = document.getElementById("overlayTitle");
const overlayText = document.getElementById("overlayText");
const startBtn = document.getElementById("startBtn");
const copyBtn = document.getElementById("copyBtn");
const toast = document.getElementById("toast");

const comboBar = document.getElementById("comboBar");
const targetText = document.getElementById("targetText");
targetText.textContent = targetScore;

const pStarEl = document.getElementById("pStar");
const pIceEl  = document.getElementById("pIce");
const pBombEl = document.getElementById("pBomb");
const tapTip = document.getElementById("tapTip");

document.getElementById("gameTitle").textContent = `æˆ³æˆ³æ¶ˆæ°”æ€ª Â· å“„å“„${gfName}ï¼ˆåŠ å¼ºç‰ˆï¼‰`;

function resize(){
  const r = stage.getBoundingClientRect();
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  canvas.width = Math.floor(r.width * dpr);
  canvas.height = Math.floor(r.height * dpr);
  canvas.style.width = r.width + "px";
  canvas.style.height = r.height + "px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener("resize", resize);
resize();

function rand(a,b){ return a + Math.random()*(b-a); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/** ===== è½»é‡éŸ³æ•ˆï¼ˆä¸ä¾èµ–æ–‡ä»¶ï¼‰ ===== */
let audioOn = true;
let ac = null;
function beep(freq=440, dur=0.05, type="sine", vol=0.06){
  if (!audioOn) return;
  if (!ac) ac = new (window.AudioContext || window.webkitAudioContext)();
  const t0 = ac.currentTime;
  const o = ac.createOscillator();
  const g = ac.createGain();
  o.type = type;
  o.frequency.setValueAtTime(freq, t0);
  g.gain.setValueAtTime(vol, t0);
  g.gain.exponentialRampToValueAtTime(0.001, t0 + dur);
  o.connect(g); g.connect(ac.destination);
  o.start(t0); o.stop(t0 + dur);
}
function buzz(){ beep(120,0.08,"square",0.05); }

/** ===== æ¸¸æˆçŠ¶æ€ ===== */
let running=false, paused=false;
let tLeft=gameSeconds;
let score=0;

let comboEnergy = 0;     // 0..100
let mult = 1;            // 1..3
let starTime = 0;        // seconds left
let iceTime = 0;         // seconds left
let bombTime = 0;        // (not used as timer; kept for extension)

let starCount=0, iceCount=0, bombCount=0;

const entities = [];
const particles = [];
const floatTexts = [];
const drops = []; // é“å…·æ‰è½

// entity types
// angryCloud ğŸ˜¤: good
// happyCloud ğŸ˜Š: after hit
// thunder âš¡: trap

function setScore(v){
  score = Math.max(0, Math.floor(v));
  scoreEl.textContent = score;
}
function setComboEnergy(v){
  comboEnergy = clamp(v, 0, 100);
  comboBar.style.width = comboEnergy + "%";
  // mult thresholds
  const newMult = comboEnergy >= 70 ? 3 : comboEnergy >= 35 ? 2 : 1;
  if (newMult !== mult){
    mult = newMult;
    multEl.textContent = "x" + mult;
    beep(newMult===3?880:660, 0.06, "triangle", 0.05);
  }
}
function toastMsg(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.classList.remove("show"), 900);
}
function vibrate(ms=18){
  try{ navigator.vibrate && navigator.vibrate(ms); }catch(e){}
}

/** ===== ç”Ÿæˆä¸ç»˜åˆ¶ ===== */
function spawnEntity(){
  const w = canvas.clientWidth || stage.clientWidth;
  const h = canvas.clientHeight || stage.clientHeight;
  const r = rand(40, 68);
  const isThunder = Math.random() < (0.18 + (1 - tLeft/gameSeconds)*0.12); // è¶ŠåæœŸé›·äº‘ç•¥å¤š
  entities.push({
    type: isThunder ? "thunder" : "angry",
    x: rand(24, w-24),
    y: rand(96, h-26),
    r,
    vx: rand(-25,25),
    vy: rand(-16,16),
    born: performance.now(),
    life: rand(2400, 3400),
    hit: false
  });
}

function spawnParticles(x,y,emoji, n=10){
  for(let i=0;i<n;i++){
    particles.push({
      x,y,
      vx: rand(-90,90),
      vy: rand(-120,-20),
      g: rand(260,360),
      a: 1,
      s: rand(0.8, 1.35),
      rot: rand(-1.2, 1.2),
      emoji
    });
  }
}
function spawnFloat(x,y,txt){
  floatTexts.push({x,y,txt, vy:-55, a:1});
}
function spawnDrop(x,y){
  // é“å…·ï¼šâ­â„ï¸ğŸ’£ï¼Œæ¦‚ç‡åä½
  const p = Math.random();
  const kind = p < 0.50 ? "star" : p < 0.82 ? "ice" : "bomb";
  drops.push({x,y, kind, vy: rand(50,90), a:1});
}

function drawCloudBody(x,y,r, mood){
  ctx.save();
  ctx.translate(x,y);
  ctx.beginPath();
  ctx.fillStyle = mood==="angry" ? "rgba(60,72,90,.22)" : "rgba(255,77,141,.14)";
  ctx.arc(0, 0, r*0.62, 0, Math.PI*2);
  ctx.arc(-r*0.45, r*0.05, r*0.45, 0, Math.PI*2);
  ctx.arc(r*0.45, r*0.08, r*0.50, 0, Math.PI*2);
  ctx.arc(0, r*0.22, r*0.55, 0, Math.PI*2);
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.strokeStyle = mood==="angry" ? "rgba(60,72,90,.25)" : "rgba(255,77,141,.22)";
  ctx.stroke();

  ctx.font = `${Math.floor(r*0.9)}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(mood==="angry" ? "ğŸ˜¤" : "ğŸ˜Š", 0, -2);
  ctx.restore();
}

function drawThunder(x,y,r){
  ctx.save();
  ctx.translate(x,y);
  ctx.beginPath();
  ctx.fillStyle = "rgba(30,30,30,.18)";
  ctx.arc(0, 0, r*0.62, 0, Math.PI*2);
  ctx.arc(-r*0.45, r*0.05, r*0.45, 0, Math.PI*2);
  ctx.arc(r*0.45, r*0.08, r*0.50, 0, Math.PI*2);
  ctx.arc(0, r*0.22, r*0.55, 0, Math.PI*2);
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.strokeStyle = "rgba(0,0,0,.18)";
  ctx.stroke();

  ctx.font = `${Math.floor(r*0.9)}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("âš¡", 0, -2);
  ctx.restore();
}

function drawDrop(d){
  ctx.save();
  ctx.translate(d.x, d.y);
  ctx.globalAlpha = d.a;
  ctx.font = `24px system-ui, Apple Color Emoji, Segoe UI Emoji`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  const e = d.kind==="star" ? "â­" : d.kind==="ice" ? "â„ï¸" : "ğŸ’£";
  ctx.fillText(e, 0, 0);
  ctx.restore();
}

function drawParticle(p){
  ctx.save();
  ctx.translate(p.x,p.y);
  ctx.rotate(p.rot);
  ctx.globalAlpha = p.a;
  ctx.font = `${Math.floor(20*p.s)}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(p.emoji,0,0);
  ctx.restore();
}
function drawFloat(f){
  ctx.save();
  ctx.globalAlpha = f.a;
  ctx.font = "800 14px system-ui";
  ctx.fillStyle = "rgba(0,0,0,.78)";
  ctx.textAlign = "center";
  ctx.fillText(f.txt, f.x, f.y);
  ctx.restore();
}

/** ===== ä¸»å¾ªç¯ ===== */
let last = performance.now();
let spawnAcc = 0;

function step(now){
  const dt = Math.min(0.033, (now-last)/1000);
  last = now;

  const w = canvas.clientWidth || stage.clientWidth;
  const h = canvas.clientHeight || stage.clientHeight;

  if (running && !paused){
    tLeft -= dt;
    if (tLeft <= 0){
      tLeft = 0;
      endGame();
    }
    timeEl.textContent = tLeft.toFixed(1);

    // é“å…·è®¡æ—¶
    if (starTime > 0) starTime = Math.max(0, starTime - dt);
    if (iceTime > 0) iceTime = Math.max(0, iceTime - dt);

    // éš¾åº¦é€’å¢ï¼šåæœŸæ›´é¢‘ç¹ç”Ÿæˆ
    const progress = 1 - tLeft/gameSeconds; // 0..1
    const spawnEvery = 0.58 - progress*0.20; // from 0.58 to 0.38
    spawnAcc += dt;
    if (spawnAcc > spawnEvery){
      spawnAcc = 0;
      if (entities.length < 10) spawnEntity();
    }

    // æ›´æ–°å®ä½“
    for(let i=entities.length-1; i>=0; i--){
      const e = entities[i];
      const speedFactor = iceTime>0 ? 0.38 : 1;
      // åæœŸåŠ é€Ÿ
      const difficultyBoost = 1 + progress*0.35;
      e.x += e.vx * dt * speedFactor * difficultyBoost;
      e.y += e.vy * dt * speedFactor * difficultyBoost;

      if (e.x < 24 || e.x > w-24) e.vx *= -1;
      if (e.y < 96 || e.y > h-26) e.vy *= -1;

      if (now - e.born > e.life) entities.splice(i,1);
    }

    // æ‰è½é“å…·
    for(let i=drops.length-1; i>=0; i--){
      const d = drops[i];
      d.y += d.vy * dt;
      d.a -= 0.22 * dt;
      if (d.a <= 0 || d.y > h+30) drops.splice(i,1);
    }

    // ç²’å­
    for(let i=particles.length-1; i>=0; i--){
      const p = particles[i];
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.vy += p.g * dt;
      p.a -= 1.3 * dt;
      if (p.a <= 0 || p.y > h+40) particles.splice(i,1);
    }
    // æµ®å­—
    for(let i=floatTexts.length-1; i>=0; i--){
      const f = floatTexts[i];
      f.y += f.vy * dt;
      f.a -= 1.3 * dt;
      if (f.a <= 0) floatTexts.splice(i,1);
    }

    // è½»å¾®è¿å‡»è¡°å‡ï¼ˆéœ€è¦æŒç»­å‘½ä¸­ï¼‰
    setComboEnergy(comboEnergy - 10*dt);
  }

  // ç»˜åˆ¶
  ctx.clearRect(0,0,w,h);
  // èƒŒæ™¯ç‚¹ç‚¹
  ctx.save();
  ctx.globalAlpha = 0.35;
  for(let i=0;i<26;i++){
    ctx.beginPath();
    const x = (i*41 + (now/40)%41) % (w+40) - 20;
    const y = 88 + (i*57) % (h-88);
    ctx.fillStyle = i%2 ? "rgba(255,77,141,.15)" : "rgba(108,124,255,.12)";
    ctx.arc(x,y, 4+(i%3), 0, Math.PI*2);
    ctx.fill();
  }
  ctx.restore();

  // çŠ¶æ€æç¤º
  if (starTime>0){
    ctx.save();
    ctx.globalAlpha = 0.9;
    ctx.font = "800 12px system-ui";
    ctx.fillStyle = "rgba(255,77,141,.9)";
    ctx.fillText(`â­ åŒå€å¾—åˆ† ${starTime.toFixed(0)}s`, 14, 76);
    ctx.restore();
  }
  if (iceTime>0){
    ctx.save();
    ctx.globalAlpha = 0.9;
    ctx.font = "800 12px system-ui";
    ctx.fillStyle = "rgba(108,124,255,.95)";
    ctx.fillText(`â„ï¸ å†°å†»å‡é€Ÿ ${iceTime.toFixed(0)}s`, 14, 92);
    ctx.restore();
  }

  // å®ä½“
  for(const e of entities){
    if (e.type === "thunder") drawThunder(e.x,e.y,e.r);
    else drawCloudBody(e.x,e.y,e.r, e.hit ? "happy" : "angry");
  }
  // æ‰è½
  drops.forEach(drawDrop);
  // ç²’å­ & æµ®å­—
  particles.forEach(drawParticle);
  floatTexts.forEach(drawFloat);

  requestAnimationFrame(step);
}
requestAnimationFrame(step);

/** ===== ç‚¹å‡»åˆ¤å®š ===== */
function getPos(ev){
  const rect = canvas.getBoundingClientRect();
  const p = (ev.touches && ev.touches[0]) ? ev.touches[0] : ev;
  return { x: p.clientX - rect.left, y: p.clientY - rect.top };
}
function inCircle(x,y,cx,cy,r){
  const dx=x-cx, dy=y-cy; return dx*dx + dy*dy <= r*r;
}

function applyDrop(kind){
  if (kind === "star"){
    starTime = 10;
    beep(880,0.06,"triangle",0.05);
    toastMsg("â­ åŒå€å¾—åˆ†å¯åŠ¨ï¼");
  } else if (kind === "ice"){
    iceTime = 6;
    beep(520,0.06,"sine",0.05);
    toastMsg("â„ï¸ å†°å†»å‡é€Ÿå¯åŠ¨ï¼");
  } else if (kind === "bomb"){
    // æ¸…å±çˆ½æ„Ÿï¼šæ¸…æ‰ä¸€åŠå®ä½“å¹¶åŠ åˆ†
    const removed = Math.min(entities.length, 6);
    for(let i=0;i<removed;i++){
      const e = entities.pop();
      if (e) spawnParticles(e.x,e.y,"ğŸ’¥",10);
    }
    const gain = 25 + removed*4;
    setScore(score + gain);
    setComboEnergy(comboEnergy + 18);
    beep(160,0.08,"square",0.06);
    toastMsg(`ğŸ’£ æ¸…å±ï¼+${gain}ğŸ’—`);
  }
}

function hitTest(x,y){
  // å…ˆåˆ¤å®šæ‰è½é“å…·ï¼ˆä¼˜å…ˆæ”¶é›†ï¼‰
  for(let i=drops.length-1; i>=0; i--){
    const d = drops[i];
    if (inCircle(x,y,d.x,d.y,18)){
      drops.splice(i,1);
      applyDrop(d.kind);
      spawnParticles(x,y, d.kind==="star"?"â­":d.kind==="ice"?"â„ï¸":"ğŸ’£", 10);
      vibrate(12);
      return true;
    }
  }

  // å†åˆ¤å®šå®ä½“ï¼ˆä»ä¸Šå¾€ä¸‹ï¼‰
  for(let i=entities.length-1; i>=0; i--){
    const e = entities[i];
    if (inCircle(x,y,e.x,e.y,e.r*0.72)){
      if (e.type === "thunder"){
        // æ‰£åˆ†+æ–­è¿å‡»
        setScore(score - 18);
        setComboEnergy(0);
        spawnParticles(e.x,e.y,"âš¡",12);
        spawnFloat(e.x, e.y - e.r*0.9, "æ‰£åˆ†ï¼æ–­è¿å‡»ï¼");
        buzz(); vibrate(30);
        // é›·äº‘å‘½ä¸­åæ¶ˆå¤±
        entities.splice(i,1);
        return true;
      }

      // angry cloud -> happy cloud -> remove
      if (!e.hit){
        e.hit = true;
        // å¾—åˆ†ï¼šåŸºç¡€åˆ† * å€æ•° * åŒå€é“å…·
        const base = 6 + Math.floor(Math.random()*4);
        const starMul = starTime>0 ? 2 : 1;
        const gain = base * mult * starMul;
        setScore(score + gain);

        // è¿å‡»èƒ½é‡å¢åŠ 
        setComboEnergy(comboEnergy + 18);
        spawnParticles(e.x,e.y,"ğŸ’—", 10);
        spawnFloat(e.x, e.y - e.r*0.9, `+${gain}ğŸ’—`);
        beep(660 + mult*80, 0.05, "triangle", 0.05);
        vibrate(10);

        // å°æ¦‚ç‡æ‰è½é“å…·
        if (Math.random() < 0.18) spawnDrop(e.x, e.y);

        // å‘½ä¸­åçŸ­æš‚åœç•™ä¸€ä¸‹å˜ğŸ˜Šï¼Œå†ç§»é™¤
        e.born = performance.now();
        e.life = 520;
      } else {
        // å·²ç»ğŸ˜Šï¼Œå†ç‚¹åªç»™ä¸€ç‚¹ç‚¹
        const gain = 1 * (starTime>0 ? 2 : 1);
        setScore(score + gain);
        setComboEnergy(comboEnergy + 8);
        spawnFloat(e.x, e.y - e.r*0.9, `+${gain}`);
        beep(520, 0.03, "sine", 0.03);
      }

      // æç¤ºéšè—
      tapTip.style.display = "none";

      // æå‰é€šå…³
      if (score >= targetScore) endGame(true);
      return true;
    }
  }

  // ç‚¹ç©ºï¼šè½»å¾®æƒ©ç½šè¿å‡»èƒ½é‡
  setComboEnergy(comboEnergy - 10);
  spawnFloat(x,y,"å†æˆ³å‡†ä¸€ç‚¹ï½");
  return false;
}

canvas.addEventListener("pointerdown", (e)=>{
  if (!running || paused) return;
  // è§£é”éŸ³é¢‘æƒé™ï¼ˆç¬¬ä¸€æ¬¡äº¤äº’ï¼‰
  try{ ac && ac.resume && ac.resume(); }catch(_){}
  const {x,y} = getPos(e);
  hitTest(x,y);
});

canvas.addEventListener("touchstart", (e)=>{ e.preventDefault(); }, {passive:false});

/** ===== æ§åˆ¶ä¸æµç¨‹ ===== */
function togglePause(){
  if (!running) return;
  paused = !paused;
  pauseBtn.textContent = paused ? "ç»§ç»­" : "æš‚åœ";
  toastMsg(paused ? "å·²æš‚åœ" : "ç»§ç»­å“„å“„ï¼");
}
pauseBtn.addEventListener("click", togglePause);

function buildLetter(finalScore){
  const level =
    finalScore >= targetScore + 140 ? 3 :
    finalScore >= targetScore + 60  ? 2 : 1;

  const lines = [];
  lines.push(`${gfName}ï¼š`);
  lines.push("");
  lines.push(`æˆ‘è®¤çœŸåçœï¼š${sorryReason || "æˆ‘ä¸è¯¥æƒ¹ä½ ç”Ÿæ°”"}ã€‚`);
  if (level >= 2) lines.push("æˆ‘ä¿è¯ä»¥åå…ˆæŠ±æŠ±ã€å†è®²é“ç†ï¼ˆä¸è®²ä¹Ÿè¡Œï¼‰ã€‚");
  lines.push("ä½ ç”Ÿæ°”ä¹Ÿå¾ˆå¯çˆ±ï¼Œä½†æˆ‘æ›´æƒ³çœ‹åˆ°ä½ ç¬‘ã€‚");
  if (level === 3) lines.push("æˆ‘æ„¿æ„æŠŠä½ çš„ä¸å¼€å¿ƒéƒ½â€œæ‰¿åŒ…â€ï¼Œç„¶åç”¨å¥¶èŒ¶/æŠ±æŠ±/é™ªä¼´è¿˜å€ºã€‚");
  lines.push("");
  lines.push(`ä»Šå¤©ä½ æ‰“å‡ºäº† ${finalScore} åˆ†ï¼Œæˆ‘å®£å¸ƒï¼šåæƒ…ç»ªå·²è¢«ä½ â€œæˆ³çˆ†â€ï¼`);
  lines.push("");
  lines.push(`â€”â€” ${myName}`);
  return lines.join("\n");
}

function showOverlay(title, text, badge="ğŸ é€šå…³æƒŠå–œ"){
  document.getElementById("badge").textContent = badge;
  overlayTitle.textContent = title;
  overlayText.textContent = text;
  overlay.style.display = "flex";
}

function startGame(){
  running = true; paused = false;
  tLeft = gameSeconds;
  setScore(0);
  setComboEnergy(0);
  mult = 1; multEl.textContent = "x1";
  starTime = 0; iceTime = 0;

  entities.length = 0; particles.length = 0; floatTexts.length = 0; drops.length = 0;
  tapTip.style.display = "block";
  pauseBtn.textContent = "æš‚åœ";

  // åˆå§‹åˆ·å‡ ä¸ªç›®æ ‡
  for(let i=0;i<4;i++) spawnEntity();

  overlay.style.display = "none";
  timeEl.textContent = tLeft.toFixed(1);

  // åˆå§‹åŒ–é“å…·æ˜¾ç¤ºï¼ˆé¢„ç•™ï¼šä½ ä¹‹åå¯ä»¥æ”¹æˆâ€œå¼€å±€ç»™ 1 ä¸ªç‚¸å¼¹â€ï¼‰
  starCount=0; iceCount=0; bombCount=0;
  pStarEl.textContent = starCount;
  pIceEl.textContent = iceCount;
  pBombEl.textContent = bombCount;

  toastMsg("å¼€æˆ³ï¼è¿å‡»è¶Šé«˜è¶Šçˆ½ï¼");
}

function endGame(earlyWin=false){
  running = false; paused = false;
  const win = earlyWin || score >= targetScore;
  const title = win ? `å¥½è€¶ï¼${gfName}çš„åå¿ƒæƒ…è¢«â€œæˆ³è·‘â€å•¦ï½` : `å·®ä¸€ç‚¹ç‚¹ï¼å†ç»™æˆ‘ä¸€æ¬¡æœºä¼šğŸ¥º`;
  const badge = win ? "ğŸ‰ å·²å“„å¥½ï¼ˆå¤§æ¦‚ï¼‰" : "ğŸ¥º ç»§ç»­åŠªåŠ›";
  const text = buildLetter(score);
  showOverlay(title, text, badge);
}

startBtn.addEventListener("click", ()=>{
  // ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶ï¼Œå”¤é†’éŸ³é¢‘ä¸Šä¸‹æ–‡
  try{
    if (!ac) ac = new (window.AudioContext || window.webkitAudioContext)();
    ac.resume && ac.resume();
  }catch(_){}
  startGame();
});

copyBtn.addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText(overlayText.textContent);
    toastMsg("å·²å¤åˆ¶ âœ…");
  }catch(e){
    toastMsg("å¤åˆ¶å¤±è´¥ï¼ˆå¯æ‰‹åŠ¨é•¿æŒ‰å¤åˆ¶ï¼‰");
  }
});

// åˆå§‹è¯´æ˜
showOverlay(
  `ç»™${gfName}çš„â€œåŠ å¼ºç‰ˆå“„å“„å°æ¸¸æˆâ€`,
  `ç©æ³•ï¼š\n- ç‚¹ğŸ˜¤å¾—åˆ†ï¼Œä¿æŒè¿å‡»èƒ½é‡ä¼šè¿›å…¥ x2/x3 å€æ•°\n- âš¡é›·äº‘åƒä¸‡åˆ«ç‚¹ï¼šæ‰£åˆ†+æ–­è¿å‡»\n- éšæœºæ‰è½é“å…·ï¼šâ­åŒå€ã€â„ï¸å‡é€Ÿã€ğŸ’£æ¸…å±\n\nç›®æ ‡ï¼š${targetScore}ğŸ’—ï¼ˆæå‰è¾¾åˆ°ä¼šç«‹åˆ»è§£é”æƒŠå–œä¿¡ï¼‰\n\næç¤ºï¼šæ‰‹æœºä¸Šç”¨æ‰‹æŒ‡æˆ³å°±è¡Œï½`,
  "ğŸ® å¼€å§‹ä¹‹å‰"
);
</script>
</body>
</html>
